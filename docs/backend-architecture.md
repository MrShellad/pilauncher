
# ğŸ¦€ PiLauncher

# Rust åç«¯æ¶æ„è®¾è®¡æ–‡æ¡£ï¼ˆTauriï¼‰

---

# 1. åç«¯è®¾è®¡ç›®æ ‡

Rust åç«¯è´Ÿè´£ï¼š

* æ–‡ä»¶ç³»ç»Ÿç®¡ç†
* å®ä¾‹ç®¡ç†
* ç‰ˆæœ¬è§£æ
* èµ„æºä¸‹è½½
* Hash æ ¡éªŒ
* æ¸¸æˆå¯åŠ¨
* æ—¥å¿—æ•è·
* é”™è¯¯ç»Ÿä¸€ç®¡ç†

å‰ç«¯æ°¸è¿œä¸ç›´æ¥æ“ä½œç³»ç»Ÿã€‚

---

# 2. æ€»ä½“æ¶æ„åˆ†å±‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Tauri Commands        â”‚  â† æ¥å£å±‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Service Layer        â”‚  â† ä¸šåŠ¡é€»è¾‘
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       Domain / Core Layer    â”‚  â† æ ¸å¿ƒæ¨¡å‹
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Infrastructure Layer    â”‚  â† IO / ç½‘ç»œ / è¿›ç¨‹
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

åŸåˆ™ï¼š

* Command åªåšå‚æ•°è§£æ
* Service è´Ÿè´£ä¸šåŠ¡æµç¨‹
* Core è´Ÿè´£æ•°æ®ç»“æ„
* Infra è´Ÿè´£ IO

---

# 3. é¡¹ç›®ç›®å½•ç»“æ„

```
src-tauri/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ lib.rs
â”‚   â”œâ”€â”€ main.rs
â”‚   â”œâ”€â”€ commands/
â”‚   â”‚   â”œâ”€â”€ instance.rs
â”‚   â”‚   â”œâ”€â”€ download.rs
â”‚   â”‚   â””â”€â”€ launch.rs
â”‚   â”‚
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ instance_service.rs
â”‚   â”‚   â”œâ”€â”€ download_service.rs
â”‚   â”‚   â””â”€â”€ launch_service.rs
â”‚   â”‚
â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”œâ”€â”€ instance.rs
â”‚   â”‚   â”œâ”€â”€ version.rs
â”‚   â”‚   â””â”€â”€ account.rs
â”‚   â”‚
â”‚   â”œâ”€â”€ infra/
â”‚   â”‚   â”œâ”€â”€ fs.rs
â”‚   â”‚   â”œâ”€â”€ http.rs
â”‚   â”‚   â”œâ”€â”€ process.rs
â”‚   â”‚   â””â”€â”€ hash.rs
â”‚   â”‚
â”‚   â”œâ”€â”€ state/
â”‚   â”‚   â””â”€â”€ app_state.rs
â”‚   â”‚
â”‚   â””â”€â”€ error.rs
```

---

# 4. Tauri Command å±‚è®¾è®¡

åŸåˆ™ï¼š

* Command åªåšè¾“å…¥è¾“å‡º
* ä¸å†™ä¸šåŠ¡é€»è¾‘
* è¿”å›ç»Ÿä¸€ Result

ç¤ºä¾‹ï¼š

```rust
#[tauri::command]
pub async fn create_instance(name: String) -> Result<(), AppError> {
    instance_service::create(name).await
}
```

ä¸è¦åœ¨ command å†…å†™ï¼š

* æ–‡ä»¶åˆ›å»º
* ä¸‹è½½é€»è¾‘
* å¯åŠ¨æµç¨‹

---

# 5. Domain å±‚è®¾è®¡

Domain å±‚åªå®šä¹‰ï¼š

* æ•°æ®ç»“æ„
* ä¸åŒ…å« IO

ç¤ºä¾‹ï¼š

```rust
#[derive(Serialize, Deserialize, Clone)]
pub struct Instance {
    pub id: String,
    pub name: String,
    pub version: String,
    pub path: String,
}
```

ä¸è¦åœ¨è¿™é‡Œï¼š

* è°ƒç”¨ç½‘ç»œ
* è®¿é—®æ–‡ä»¶ç³»ç»Ÿ

---

# 6. Service å±‚è®¾è®¡

Service è´Ÿè´£ï¼š

* æµç¨‹ç¼–æ’
* è°ƒç”¨ infra
* æ•°æ®è½¬æ¢

ç¤ºä¾‹ï¼š

```rust
pub async fn create(name: String) -> Result<(), AppError> {
    let id = generate_id();
    let path = fs::create_instance_dir(&id)?;

    let instance = Instance {
        id,
        name,
        version: "1.20.1".into(),
        path,
    };

    fs::save_instance(&instance)?;

    Ok(())
}
```

Service å¯ä»¥ï¼š

* è°ƒç”¨å¤šä¸ª infra æ¨¡å—
* åšæ ¡éªŒ
* ç»„åˆæµç¨‹

---

# 7. Infrastructure å±‚è®¾è®¡

Infra è´Ÿè´£ï¼š

* æ–‡ä»¶è¯»å†™
* HTTP è¯·æ±‚
* è¿›ç¨‹å¯åŠ¨
* Hash æ ¡éªŒ

ç¤ºä¾‹ï¼š

## 7.1 æ–‡ä»¶ç³»ç»Ÿ

```rust
pub fn create_instance_dir(id: &str) -> Result<String, AppError> {
    let path = format!("instances/{}", id);
    std::fs::create_dir_all(&path)?;
    Ok(path)
}
```

---

## 7.2 HTTP ä¸‹è½½

ä½¿ç”¨ï¼š

```
reqwest + tokio
```

æ”¯æŒï¼š

* æ–­ç‚¹ç»­ä¼ 
* è¿›åº¦å›è°ƒ
* è¶…æ—¶æ§åˆ¶

---

## 7.3 è¿›ç¨‹ç®¡ç†

```rust
pub fn launch_game(cmd: &str, args: &[String]) -> Result<(), AppError> {
    std::process::Command::new(cmd)
        .args(args)
        .spawn()?;
    Ok(())
}
```

å¿…é¡»æ”¯æŒï¼š

* stdout æ•è·
* stderr æ•è·
* é€€å‡ºç å¤„ç†

---

# 8. å…¨å±€çŠ¶æ€ç®¡ç†

ä½¿ç”¨ï¼š

```
tauri::State
```

ç¤ºä¾‹ï¼š

```rust
pub struct AppState {
    pub download_manager: Mutex<DownloadManager>,
}
```

ä¸è¦ç”¨å…¨å±€ staticã€‚

---

# 9. é”™è¯¯ç³»ç»Ÿè®¾è®¡

ç»Ÿä¸€é”™è¯¯ç±»å‹ï¼š

```rust
#[derive(Debug, thiserror::Error)]
pub enum AppError {
    #[error("IO error")]
    Io(#[from] std::io::Error),

    #[error("Network error")]
    Network(#[from] reqwest::Error),

    #[error("Invalid instance")]
    InvalidInstance,
}
```

æ‰€æœ‰ command è¿”å›ï¼š

```
Result<T, AppError>
```

å‰ç«¯ç»Ÿä¸€è§£æã€‚

---

# 10. ä¸‹è½½æ¨¡å—æ¶æ„

ä¸‹è½½æ¨¡å—å¿…é¡»æ”¯æŒï¼š

* é˜Ÿåˆ—
* å¹¶å‘æ§åˆ¶
* è¿›åº¦äº‹ä»¶
* å–æ¶ˆä»»åŠ¡

ç»“æ„ï¼š

```
DownloadManager
 â”œâ”€ Queue
 â”œâ”€ Worker Pool
 â”œâ”€ EventEmitter
```

ä½¿ç”¨ tokio + channelã€‚

---

# 11. å¯åŠ¨æ¨¡å—æ¶æ„

å¯åŠ¨æµç¨‹ï¼š

1. æ ¡éªŒå®ä¾‹
2. æ ¡éªŒç‰ˆæœ¬æ–‡ä»¶
3. æ ¡éªŒä¾èµ–
4. æ„å»ºå¯åŠ¨å‚æ•°
5. å¯åŠ¨è¿›ç¨‹
6. æ•è·æ—¥å¿—

å¿…é¡»æ”¯æŒï¼š

* å´©æºƒæ£€æµ‹
* é€€å‡ºç å›è°ƒ
* å¯åŠ¨å¤±è´¥è¿”å›

---

# 12. æ—¥å¿—ç³»ç»Ÿ

ä½¿ç”¨ï¼š

```
tracing + tracing_subscriber
```

æ—¥å¿—çº§åˆ«ï¼š

* INFO
* WARN
* ERROR
* DEBUG

å‰ç«¯å¯é€‰æ‹©è¯»å–æ—¥å¿—æµã€‚

---

# 13. å®‰å…¨ç­–ç•¥

* ç¦æ­¢å‰ç«¯ä¼ å…¥ä»»æ„å‘½ä»¤
* å¯åŠ¨å‚æ•°å¿…é¡»ç™½åå•æ ¡éªŒ
* æ–‡ä»¶è·¯å¾„å¿…é¡» normalize
* ä¸å…è®¸è·¯å¾„ç©¿è¶Šæ”»å‡»

---

# 14. å¯æ‰©å±•è®¾è®¡

æœªæ¥æ‰©å±•ï¼š

* å¤šè´¦æˆ·ç³»ç»Ÿ
* å¾®è½¯ç™»å½•
* Forge/Fabric è‡ªåŠ¨å®‰è£…
* èµ„æºé•œåƒåˆ‡æ¢
* æ’ä»¶ç³»ç»Ÿ

æ¶æ„å¿…é¡»æ¨¡å—åŒ–ã€‚

---

# 15. æ€§èƒ½ä¼˜åŒ–åŸåˆ™

* ä¸‹è½½ä½¿ç”¨å¼‚æ­¥
* é¿å…é˜»å¡ä¸»çº¿ç¨‹
* IO ç»Ÿä¸€ async
* å¤§æ–‡ä»¶åˆ†å—å†™å…¥

---

# 16. å‘å¸ƒå‡†å¤‡

* Release æ¨¡å¼æ„å»º
* å¼€å¯ LTO
* strip debug symbols
* å¯ç”¨ panic = abort

---

# ç»“è®º

åç«¯æ¶æ„æ ¸å¿ƒæ€æƒ³ï¼š

* æ¸…æ™°åˆ†å±‚
* è´£ä»»å•ä¸€
* ç»Ÿä¸€é”™è¯¯ç³»ç»Ÿ
* æ¨¡å—åŒ–æ‰©å±•
* å‰åç«¯èŒè´£æ˜ç¡®

